<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Параметры объекта</title>

  <style>
    :root{
      --bg0:#0b0c10; --bg1:#111219;
      --line:rgba(255,255,255,.10); --line2:rgba(255,255,255,.06);
      --text:#f4f6fb; --muted:rgba(244,246,251,.70);
      --hover:rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 25% 10%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(900px 500px at 80% 70%, rgba(255,255,255,.05), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 55%, #07080c);
    }
    .wrap{max-width:980px;margin:0 auto;padding:40px 18px 48px}
    h1{
      margin:0 0 18px 0;
      font-weight:800; letter-spacing:-0.03em; line-height:0.98;
      font-size:clamp(34px,5vw,62px);
    }
    .table-card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line2);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 18px 60px rgba(0,0,0,.5);
    }
    table{width:100%;border-collapse:collapse}
    thead{display:none}
    tbody td{
      padding:18px;
      border-bottom:1px solid var(--line);
      font-size:15px;
    }
    tbody tr:last-child td{border-bottom:none}
    tbody tr{transition:background-color .18s ease}
    tbody tr:hover{background:var(--hover)}
    .label{width:52%;color:rgba(255,255,255,.85)}
    .value{width:48%}

    select,input{
      width:100%;
      padding:12px;
      font-size:16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    select:focus,input:focus{
      border-color:rgba(255,255,255,.28);
      background:rgba(0,0,0,.35);
      box-shadow:0 0 0 3px rgba(255,255,255,.06);
    }
    select{
      appearance:none;
      padding-right:34px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.7) 50%),
        linear-gradient(135deg, rgba(255,255,255,.7) 50%, transparent 50%);
      background-position:calc(100% - 18px) 50%, calc(100% - 12px) 50%;
      background-size:6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }
    select:disabled, input:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .actions{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:16px 18px;border-top:1px solid var(--line2);
      background:rgba(255,255,255,.01);
    }
    button{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
    }
    button.primary{background:rgba(255,255,255,.12)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .status{margin-left:auto;color:var(--muted);font-size:13px;min-width:220px;text-align:right}
    .ok{color:#8ff0c8}
    .bad{color:#ffb4b4}

    @media (max-width:520px){
      table, tbody, tr, td{display:block}
      tbody tr{padding:12px;border-bottom:1px solid var(--line)}
      tbody td{border:none;padding:8px 0}
      .label,.value{width:100%}
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Форма параметров</h1>

  <div class="table-card">
    <table>
      <tbody>
        <tr>
          <td class="label">Тип спецтехники</td>
          <td class="value">
            <select id="type">
              <option value="">Загрузка…</option>
            </select>
          </td>
        </tr>

        <tr>
          <td class="label">Марка</td>
          <td class="value">
            <select id="brand" disabled>
              <option value="">Сначала выберите тип</option>
            </select>
          </td>
        </tr>

        <tr>
          <td class="label">Модель</td>
          <td class="value">
            <select id="model" disabled>
              <option value="">Сначала выберите марку</option>
            </select>
          </td>
        </tr>

        <tr>
          <td class="label">Год выпуска</td>
          <td class="value">
            <input id="year" type="number" min="1950" max="2035" placeholder="например: 2016" disabled>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="actions">
      <button class="primary" id="sendBtn" disabled>Отправить</button>
      <button id="resetBtn" type="button">Сброс</button>
      <div class="status" id="status">Загрузка справочника…</div>
    </div>
  </div>
</div>

<script>
  const GOOGLE_DICT_URL = "https://script.google.com/macros/s/AKfycbwzTz6k_hMbn8H161OZJX5cs5j-8vFN2FhHUsiwkF-5U29-do5iABNTfUkQKGnmeAcReA/exec";
  const MAKE_WEBHOOK_URL = "https://hook.eu1.make.com/g5xtk9ovxlzspdemrwr7ic2euyarblgi";

  const el = {
    type: type,
    brand: brand,
    model: model,
    year: year,
    send: sendBtn,
    reset: resetBtn,
    status
  };

  function setStatus(msg, kind){
    el.status.textContent = msg;
    el.status.className = "status " + (kind || "");
  }

  function getSid(){
    return new URLSearchParams(location.search).get("sid");
  }

  let dict = { types:[], brands:new Map(), models:new Map() };

  function buildDict(rows){
    const t = new Set();
    const b = new Map();
    const m = new Map();
    rows.forEach(r=>{
      const type=r.type?.trim(), brand=r.brand?.trim(), model=r.model?.trim();
      if(!type||!brand||!model) return;
      t.add(type);
      if(!b.has(type)) b.set(type,new Set());
      b.get(type).add(brand);
      const k=`${type}||${brand}`;
      if(!m.has(k)) m.set(k,new Set());
      m.get(k).add(model);
    });
    dict.types=[...t];
    dict.brands=b;
    dict.models=m;
  }

  function setOptions(sel, arr, ph){
    sel.innerHTML="";
    sel.append(new Option(ph,""));
    arr.forEach(v=>sel.append(new Option(v,v)));
  }

  function resetFrom(lvl){
    if(lvl<2){ el.brand.disabled=true; setOptions(el.brand,[],"Сначала выберите тип"); }
    if(lvl<3){ el.model.disabled=true; setOptions(el.model,[],"Сначала выберите марку"); }
    if(lvl<4){ el.year.disabled=true; el.year.value=""; }
    el.send.disabled=true;
  }

  type.onchange=()=>{
    resetFrom(1);
    const t=el.type.value;
    if(!t) return setStatus("Выберите тип");
    setOptions(el.brand,[...dict.brands.get(t)||[]],"— выберите —");
    el.brand.disabled=false;
    setStatus("Выберите марку");
  };

  brand.onchange=()=>{
    resetFrom(2);
    const t=el.type.value, b=el.brand.value;
    if(!b) return;
    setOptions(el.model,[...dict.models.get(`${t}||${b}`)||[]],"— выберите —");
    el.model.disabled=false;
    setStatus("Выберите модель");
  };

  model.onchange=()=>{
    resetFrom(3);
    if(!el.model.value) return;
    el.year.disabled=false;
    setStatus("Укажите год выпуска");
  };

  year.oninput=()=>{
    const y=+el.year.value;
    if(y>=1950&&y<=2035){
      el.send.disabled=false;
      setStatus("Можно отправлять");
    } else {
      el.send.disabled=true;
    }
  };

  resetBtn.onclick=()=>{
    type.value="";
    resetFrom(0);
    setStatus("Сброшено");
  };

  sendBtn.onclick=async()=>{
    const payload={
      sid:getSid(),
      sentAt:new Date().toISOString(),
      type_special:el.type.value,
      brand:el.brand.value,
      model:el.model.value,
      year:+el.year.value
    };

    try{
      setStatus("Отправляю…");
      const r=await fetch(MAKE_WEBHOOK_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      if(!r.ok) throw new Error(r.status);
      setStatus("Отправлено ✅","ok");

      if(matchMedia("(max-width:520px)").matches){
        window.close();
        setTimeout(()=>document.body.innerHTML="<h2 style='color:white;text-align:center'>Готово ✅<br>Вернитесь в Telegram</h2>",300);
      }
    }catch(e){
      setStatus("Ошибка отправки","bad");
    }
  };

  function loadJsonp(){
    return new Promise((res,rej)=>{
      const cb="cb"+Math.random().toString(16).slice(2);
      window[cb]=d=>{ delete window[cb]; s.remove(); res(d); };
      const s=document.createElement("script");
      s.src=GOOGLE_DICT_URL+"?callback="+cb;
      s.onerror=()=>rej();
      document.head.appendChild(s);
    });
  }

  (async()=>{
    try{
      const d=await loadJsonp();
      buildDict(d.rows||[]);
      setOptions(el.type,dict.types,"— выберите —");
      resetFrom(0);
      setStatus("Выберите тип");
    }catch{
      setStatus("Ошибка загрузки справочника","bad");
    }
  })();
</script>
</body>
</html>

